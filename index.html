<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»‹è­·äº‹æ¥­æ‰€ ç©ºãçŠ¶æ³ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Arial', sans-serif; background: linear-gradient(135deg, #F5EEF8 0%, #E9E3EB 100%); padding: 20px; min-height: 100vh; }
        .container { max-width: 1400px; margin: 0 auto; background: white; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.08); overflow: hidden; }
        .header { background: linear-gradient(135deg, #D99AAD 0%, #C789A0 100%); color: white; padding: 30px; text-align: center; }
        .header h1 { font-size: 28px; margin-bottom: 8px; }
        .header p { font-size: 14px; opacity: 0.95; }
        .tabs { display: flex; background: #F9F6F8; border-bottom: 2px solid #E9DFE5; }
        .tab-btn { flex: 1; padding: 15px; border: none; background: none; cursor: pointer; font-size: 14px; font-weight: bold; border-bottom: 3px solid transparent; transition: all 0.3s; color: #2D2E1B; }
        .tab-btn.active { background: white; border-bottom: 3px solid #D99AAD; color: #D99AAD; }
        .tab-btn:hover { background: #FBF9FA; }
        .content { display: none; padding: 30px; background: #FEFEFE; }
        .content.active { display: block; }
        .facility-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .facility-card { border: 2px solid #E9E3EB; border-radius: 12px; padding: 20px; background: #FAFAFA; transition: all 0.3s; cursor: pointer; }
        .facility-card:hover { box-shadow: 0 6px 20px rgba(217,154,173,0.15); transform: translateY(-2px); border-color: #D99AAD; }
        .facility-card.has-vacancy { background: #FBF9FA; }
        .facility-card.category-day { border-left: 5px solid #B8A5B0; }
        .facility-card.category-visit { border-left: 5px solid #9BA5B8; }
        .facility-card.category-facility { border-left: 5px solid #A5B8A5; }
        .facility-card.category-disability { border-left: 5px solid #C9B59B; }
        .facility-card.category-complex { border-left: 5px solid #C799A8; }
        .facility-name { font-size: 15px; font-weight: bold; margin-bottom: 8px; color: #2D2E1B; }
        .facility-type { font-size: 12px; color: #6B6B6B; margin-bottom: 12px; background: #F5F1F3; padding: 4px 8px; border-radius: 4px; display: inline-block; }
        .vacancy-status { font-size: 13px; margin-bottom: 8px; padding: 8px; border-radius: 6px; text-align: center; font-weight: bold; }
        .vacancy-available { background: #F3E6EC; color: #7B4A5B; }
        .vacancy-limited { background: #F9F5F7; color: #8B5C6E; }
        .vacancy-none { background: #F9F5F7; color: #A0798B; }
        .day-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; margin-bottom: 12px; }
        .day-cell { font-size: 11px; padding: 6px; border-radius: 4px; text-align: center; border: 1px solid #E0E0E0; }
        .day-cell.available { background: #E9DFE5; color: #5A3A47; font-weight: bold; }
        .day-cell.unavailable { background: #F5F5F5; color: #999; }
        .detail-btn { width: 100%; padding: 10px; background: #D99AAD; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 13px; margin-top: 10px; transition: all 0.3s; }
        .detail-btn:hover { background: #C789A0; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(45,46,27,0.4); z-index: 1000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; border-radius: 12px; padding: 30px; max-width: 600px; max-height: 80vh; overflow-y: auto; box-shadow: 0 10px 50px rgba(0,0,0,0.2); }
        .modal-header { font-size: 22px; font-weight: bold; margin-bottom: 20px; color: #D99AAD; display: flex; justify-content: space-between; align-items: center; }
        .close-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: #999; }
        .close-btn:hover { color: #666; }
        .day-section { margin-bottom: 20px; padding: 15px; background: #FBF9FA; border-radius: 8px; border-left: 4px solid #D99AAD; }
        .day-title { font-size: 14px; font-weight: bold; color: #D99AAD; margin-bottom: 10px; }
        .info-row { display: flex; justify-content: space-between; margin: 8px 0; font-size: 13px; }
        .info-label { color: #6B6B6B; font-weight: bold; }
        .info-value { color: #2D2E1B; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-size: 12px; font-weight: bold; margin-bottom: 5px; color: #2D2E1B; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 8px; border: 1px solid #E9E3EB; border-radius: 4px; font-size: 13px; font-family: Arial, sans-serif; background: white; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: #D99AAD; box-shadow: 0 0 0 2px rgba(217,154,173,0.1); }
        .form-group textarea { min-height: 60px; resize: vertical; }
        .facility-selector { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; margin-bottom: 20px; }
        .selector-btn { padding: 12px; border: 2px solid #E9E3EB; background: white; cursor: pointer; border-radius: 6px; font-weight: bold; font-size: 13px; color: #2D2E1B; transition: all 0.3s; }
        .selector-btn.active { background: #D99AAD; color: white; border-color: #D99AAD; }
        .selector-btn:hover { border-color: #D99AAD; background: #FBF9FA; }
        .checkbox-group { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin: 8px 0; }
        .checkbox-item { display: flex; align-items: center; gap: 6px; }
        .checkbox-item input { width: 18px; height: 18px; accent-color: #D99AAD; }
        .checkbox-item label { font-size: 13px; cursor: pointer; color: #2D2E1B; }
        .save-btn { width: 100%; padding: 12px; background: #D99AAD; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 14px; margin-top: 20px; transition: all 0.3s; }
        .save-btn:hover { background: #C789A0; }
        .info-box { background: #F9F5F7; border-left: 4px solid #D99AAD; padding: 12px; margin-bottom: 20px; border-radius: 4px; font-size: 13px; color: #2D2E1B; }
        .info-box strong { color: #7B4A5B; }
        .vacancy-badge { display: inline-block; background: #D99AAD; color: white; padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: bold; margin-left: 10px; }
        .warning-badge { display: inline-block; background: #DAB89B; color: white; padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: bold; margin-left: 10px; }
        .loading { text-align: center; padding: 40px; color: #D99AAD; font-size: 16px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“‹ ä»‹è­·äº‹æ¥­æ‰€ ç©ºãçŠ¶æ³ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h1>
            <p>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§å‹Ÿé›†çŠ¶æ³ã‚’ç¢ºèªãƒ»æ›´æ–°</p>
        </div>

        <div class="tabs">
            <button class="tab-btn active" data-tab="view">ğŸ‘ï¸ ç¢ºèªï¼ˆã‚±ã‚¢ãƒãƒã‚¸ãƒ£ãƒ¼å‘ã‘ï¼‰</button>
            <button class="tab-btn" data-tab="input">âœï¸ å…¥åŠ›ï¼ˆäº‹æ¥­æ‰€å‘ã‘ï¼‰</button>
        </div>

        <div id="view" class="content active">
            <div class="info-box">
                <strong>ğŸ“ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç©ºãçŠ¶æ³</strong>
                <p style="margin-top: 5px; font-size: 12px;">å„äº‹æ¥­æ‰€ã®å‹Ÿé›†çŠ¶æ³ã‚’ç¢ºèªã€‚æ°—ã«ãªã‚‹äº‹æ¥­æ‰€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦è©³ç´°ã‚’è¦‹ã‚‹</p>
            </div>
            <div id="loading-view" class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
            <div class="facility-grid" id="facility-list" style="display: none;"></div>
        </div>

        <div id="input" class="content">
            <div class="info-box">
                <strong>âœï¸ å‹Ÿé›†çŠ¶æ³å…¥åŠ›</strong>
                <p style="margin-top: 5px; font-size: 12px;">é€±1å›ã€äº‹æ¥­æ‰€ã®æœ€æ–°çŠ¶æ³ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
            </div>
            <div class="facility-selector" id="facility-selector"></div>
            <div id="input-form"></div>
        </div>
    </div>

    <div id="modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span id="modal-title"></span>
                <button class="close-btn" id="close-modal-btn">Ã—</button>
            </div>
            <div id="modal-body"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, set, get, onValue } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyCHDXl2caw-MRkggU8CgJtsLfBwRIF58nQ",
            authDomain: "akizyoukyou.firebaseapp.com",
            databaseURL: "https://akizyoukyou-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "akizyoukyou",
            storageBucket: "akizyoukyou.firebasestorage.app",
            messagingSenderId: "735799821776",
            appId: "1:735799821776:web:c723a365d95565104765d5"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        const facilities = [
            { id: 1, name: 'å—é‡ã‚¹ãƒ†ãƒƒãƒ—ã‚¢ãƒƒãƒ—ãƒ‡ã‚¤ã‚µãƒ¼ãƒ“ã‚¹ã‚»ãƒ³ã‚¿ãƒ¼', type: 'day', category: 'ãƒ‡ã‚¤ã‚µãƒ¼ãƒ“ã‚¹', phone: '072-781-5670', password: '1234' },
            { id: 2, name: 'è’ç‰§ãƒ‡ã‚¤ã‚µãƒ¼ãƒ“ã‚¹ã‚»ãƒ³ã‚¿ãƒ¼', type: 'day', category: 'ãƒ‡ã‚¤ã‚µãƒ¼ãƒ“ã‚¹', phone: '072-777-7006', password: '5678' },
            { id: 3, name: 'è¨ªå•ä»‹è­·äº‹æ¥­æ‰€', type: 'visit', category: 'è¨ªå•ç³»', phone: '072-781-2900', password: '2020' },
            { id: 4, name: 'è¨ªå•çœ‹è­·ã‚¹ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³', type: 'visit', category: 'è¨ªå•ç³»', phone: '072-780-2904', password: '3030' },
            { id: 5, name: 'æ±æœ‰å²¡ãƒ¯ãƒ¼ã‚¯ãƒã‚¦ã‚¹', type: 'facility', category: 'éšœå®³ç³»', phone: '072-783-9885', password: '4040' },
            { id: 6, name: 'ã‚µãƒãƒ¼ãƒˆãƒ†ãƒ©ã‚¹', type: 'facility', category: 'éšœå®³ç³»', phone: '072-773-4115', password: '5050' },
            { id: 7, name: 'é¤Šè­·è€äººãƒ›ãƒ¼ãƒ æ¾é¢¨åœ’', type: 'facility', category: 'æ–½è¨­ç³»', phone: '072-781-2900', password: '6060' },
            { id: 8, name: 'ç‰¹åˆ¥é¤Šè­·è€äººãƒ›ãƒ¼ãƒ ã‚±ã‚¢ãƒã‚¤ãƒ„ã„ãŸã¿', type: 'facility', category: 'æ–½è¨­ç³»', phone: '072-773-2286', password: '7070' },
            { id: 9, name: 'ç‰¹åˆ¥é¤Šè­·è€äººãƒ›ãƒ¼ãƒ ã‚±ã‚¢ãƒã‚¤ãƒ„ãªã‹ã®', type: 'facility', category: 'æ–½è¨­ç³»', phone: '072-781-1771', password: '8080' },
            { id: 10, name: 'çœ‹è­·å°è¦æ¨¡å¤šæ©Ÿèƒ½å±…å®…ä»‹è­·ã•ãã‚‰', type: 'complex', category: 'è¤‡åˆå‹', phone: '072-785-3365', password: '9090' },
            { id: 11, name: 'ã‚µãƒ†ãƒ©ã‚¤ãƒˆå‹çœ‹è­·å°è¦æ¨¡å¤šæ©Ÿèƒ½å±…å®…ä»‹è­·ã•ãã‚‰', type: 'complex', category: 'è¤‡åˆå‹', phone: '072-775-2884', password: '1010' }
        ];

        const days = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'];
        const dayLabels = { mon: 'æœˆ', tue: 'ç«', wed: 'æ°´', thu: 'æœ¨', fri: 'é‡‘', sat: 'åœŸ', sun: 'æ—¥' };

        let data = {};
        let currentFacility = 1;
        let authenticatedFacilities = {};

        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const tab = this.getAttribute('data-tab');
                switchTab(tab);
            });
        });

        function switchTab(tab) {
            document.querySelectorAll('.content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            
            document.getElementById(tab).classList.add('active');
            document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
            
            if (tab === 'input') renderInputForm();
            if (tab === 'view') renderFacilityList();
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«é–‰ã˜ã‚‹
        document.getElementById('close-modal-btn').addEventListener('click', closeModal);

        function closeModal() {
            document.getElementById('modal').classList.remove('active');
        }

        // Firebase ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
        async function loadData() {
            try {
                const dataRef = ref(database, 'facilities');
                const snapshot = await get(dataRef);
                
                if (snapshot.exists()) {
                    data = snapshot.val();
                } else {
                    await initData();
                }
                
                document.getElementById('loading-view').style.display = 'none';
                document.getElementById('facility-list').style.display = 'grid';
                renderFacilityList();
            } catch (error) {
                console.error('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                document.getElementById('loading-view').textContent = 'ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ';
            }
        }

        // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ã‚’ãƒªãƒƒã‚¹ãƒ³
        function setupRealtimeListener() {
            const dataRef = ref(database, 'facilities');
            onValue(dataRef, (snapshot) => {
                if (snapshot.exists()) {
                    data = snapshot.val();
                    if (document.getElementById('view').classList.contains('active')) {
                        renderFacilityList();
                    }
                }
            });
        }

        async function initData() {
            facilities.forEach(f => {
                if (f.type === 'day' || f.type === 'visit' || f.type === 'complex') {
                    data[f.id] = { holidays: [] };
                    days.forEach(d => {
                        data[f.id][d] = {
                            morning: false,
                            afternoon: false,
                            evening: false,
                            care: {},
                            disability: {},
                            note: '',
                            lastUpdated: new Date().toISOString()
                        };
                    });
                } else {
                    data[f.id] = {
                        status: 'closed',
                        capacity: 0,
                        care: {},
                        disability: {},
                        note: '',
                        phone: f.phone,
                        lastUpdated: new Date().toISOString()
                    };
                }
            });
            await saveData();
        }

        async function saveData() {
            try {
                await set(ref(database, 'facilities'), data);
            } catch (error) {
                console.error('ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                alert('ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        function isOutdated(fac_id) {
            const f = facilities.find(f => f.id === fac_id);
            let lastUpdate;
            
            if (f.type === 'day' || f.type === 'visit' || f.type === 'complex') {
                const allUpdates = days.map(d => data[fac_id][d].lastUpdated).filter(d => d);
                if (allUpdates.length === 0) return false;
                lastUpdate = new Date(allUpdates[0]);
            } else {
                lastUpdate = new Date(data[fac_id].lastUpdated);
            }
            
            const now = new Date();
            const diff = Math.floor((now - lastUpdate) / (1000 * 60 * 60 * 24));
            return diff >= 10;
        }

        function hasAvailability(fac) {
            if (fac.type === 'day' || fac.type === 'visit' || fac.type === 'complex') {
                return days.some(d => {
                    if (data[fac.id].holidays && data[fac.id].holidays.includes(d)) return false;
                    return data[fac.id][d].morning || data[fac.id][d].afternoon || data[fac.id][d].evening;
                });
            } else {
                return data[fac.id].status === 'open' || data[fac.id].status === 'limited';
            }
        }

        function renderFacilityList() {
            let html = '';
            facilities.forEach(f => {
                const available = hasAvailability(f);
                const outdated = isOutdated(f.id);
                const categoryClass = f.category === 'ãƒ‡ã‚¤ã‚µãƒ¼ãƒ“ã‚¹' ? 'day' : f.category === 'è¨ªå•ç³»' ? 'visit' : f.category === 'æ–½è¨­ç³»' ? 'facility' : f.category === 'éšœå®³ç³»' ? 'disability' : 'complex';
                
                html += `
                    <div class="facility-card ${available ? 'has-vacancy' : ''} category-${categoryClass}" data-facility-id="${f.id}">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                            <div>
                                <div class="facility-name">${f.name}</div>
                                <span class="facility-type">${f.category}</span>
                            </div>
                            <div>
                                ${available ? '<span class="vacancy-badge">ç©ºãã‚ã‚Š</span>' : ''}
                                ${outdated ? '<span class="warning-badge">10æ—¥ä»¥ä¸Šæœªæ›´æ–°</span>' : ''}
                            </div>
                        </div>
                        <div class="vacancy-status ${available ? 'vacancy-available' : 'vacancy-none'}">${available ? 'å‹Ÿé›†ä¸­' : 'å‹Ÿé›†ãªã—'}</div>
                        <div style="font-size: 12px; color: #6B6B6B;">ğŸ“ ${data[f.id].phone || f.phone}</div>
                `;

                if (f.type === 'day' || f.type === 'visit' || f.type === 'complex') {
                    html += `<div class="day-grid">`;
                    days.forEach(d => {
                        if (data[f.id].holidays && data[f.id].holidays.includes(d)) return;
                        const d_data = data[f.id][d];
                        const hasTime = d_data.morning || d_data.afternoon || d_data.evening;
                        html += `<div class="day-cell ${hasTime ? 'available' : 'unavailable'}">${dayLabels[d]}</div>`;
                    });
                    html += `</div>`;
                } else {
                    html += `<div style="font-size: 12px; margin-top: 10px; color: #6B6B6B;">å®šå“¡æ®‹æ•°: <strong>${data[f.id].capacity}å</strong></div>`;
                }

                html += `<button class="detail-btn">è©³ç´°ã‚’è¦‹ã‚‹</button></div>`;
            });
            document.getElementById('facility-list').innerHTML = html;

            // ã‚«ãƒ¼ãƒ‰ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ 
            document.querySelectorAll('.facility-card').forEach(card => {
                card.addEventListener('click', function(e) {
                    if (!e.target.classList.contains('detail-btn')) return;
                    const facId = parseInt(this.getAttribute('data-facility-id'));
                    openModal(facId);
                });
            });
        }

        function openModal(fac_id) {
            const f = facilities.find(fac => fac.id === fac_id);
            document.getElementById('modal-title').textContent = f.name;

            let body = '';
            if (f.type === 'day' || f.type === 'visit' || f.type === 'complex') {
                days.forEach(d => {
                    if (data[fac_id].holidays && data[fac_id].holidays.includes(d)) return;
                    const d_data = data[fac_id][d];
                    const times = [];
                    if (d_data.morning) times.push('åˆå‰');
                    if (d_data.afternoon) times.push('åˆå¾Œ');
                    if (d_data.evening) times.push('å¤œé–“');
                    
                    const careList = Object.keys(d_data.care).filter(k => d_data.care[k]);
                    const disabilityList = Object.keys(d_data.disability).filter(k => d_data.disability[k]);

                    body += `
                        <div class="day-section">
                            <div class="day-title">${dayLabels[d]}æ›œæ—¥ ${times.length > 0 ? `<span style="color: #22c55e;">${times.join('ãƒ»')}</span>` : '<span style="color: #999;">å—ã‘å…¥ã‚Œä¸å¯</span>'}</div>
                            ${times.length > 0 ? `
                                ${careList.length > 0 ? `<div class="info-row"><span class="info-label">å¯¾å¿œè¦ä»‹è­·åº¦:</span><span class="info-value">${careList.join('ãƒ»')}</span></div>` : ''}
                                ${disabilityList.length > 0 ? `<div class="info-row"><span class="info-label">å¯¾å¿œéšœå®³ç­‰ç´š:</span><span class="info-value">${disabilityList.map(l => `ç¬¬${l}ç´š`).join('ãƒ»')}</span></div>` : ''}
                                ${d_data.note ? `<div class="info-row"><span class="info-label">å‚™è€ƒ:</span><span class="info-value">${d_data.note}</span></div>` : ''}
                            ` : ''}
                        </div>
                    `;
                });
            } else {
                const careList = Object.keys(data[fac_id].care).filter(k => data[fac_id].care[k]);
                const disabilityList = Object.keys(data[fac_id].disability).filter(k => data[fac_id].disability[k]);
                
                body = `
                    <div class="day-section">
                        <div class="info-row"><span class="info-label">å‹Ÿé›†çŠ¶æ³:</span><span class="info-value">${data[fac_id].status === 'open' ? 'å‹Ÿé›†ä¸­' : data[fac_id].status === 'limited' ? 'é™å®šå‹Ÿé›†' : 'å‹Ÿé›†ãªã—'}</span></div>
                        <div class="info-row"><span class="info-label">å®šå“¡æ®‹æ•°:</span><span class="info-value">${data[fac_id].capacity}å</span></div>
                        ${careList.length > 0 ? `<div class="info-row"><span class="info-label">å¯¾å¿œè¦ä»‹è­·åº¦:</span><span class="info-value">${careList.join('ãƒ»')}</span></div>` : ''}
                        ${disabilityList.length > 0 ? `<div class="info-row"><span class="info-label">å¯¾å¿œéšœå®³ç­‰ç´š:</span><span class="info-value">${disabilityList.map(l => `ç¬¬${l}ç´š`).join('ãƒ»')}</span></div>` : ''}
                        ${data[fac_id].note ? `<div class="info-row"><span class="info-label">å‚™è€ƒ:</span><span class="info-value">${data[fac_id].note}</span></div>` : ''}
                    </div>
                `;
            }
            document.getElementById('modal-body').innerHTML = body;
            document.getElementById('modal').classList.add('active');
        }

        function renderInputForm() {
            console.log('renderInputForm é–‹å§‹');
            console.log('currentFacility:', currentFacility);
            console.log('authenticatedFacilities:', authenticatedFacilities);
            
            const f = facilities.find(fac => fac.id === currentFacility);
            console.log('é¸æŠã•ã‚ŒãŸäº‹æ¥­æ‰€:', f);
            
            if (!f) {
                console.error('äº‹æ¥­æ‰€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', currentFacility);
                return;
            }
            
            // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼ãƒã‚§ãƒƒã‚¯
            if (!authenticatedFacilities[currentFacility]) {
                console.log('æœªèªè¨¼ - èªè¨¼ç”»é¢ã‚’è¡¨ç¤º');
                renderAuthForm(f);
                return;
            }

            console.log('èªè¨¼æ¸ˆã¿ - å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¡¨ç¤º');
            // èªè¨¼æ¸ˆã¿ã®å ´åˆã€å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¡¨ç¤º
            renderEditForm(f);
        }

        function renderAuthForm(f) {
            let selectorHtml = '';
            facilities.forEach(fac => {
                selectorHtml += `<button class="selector-btn ${fac.id === currentFacility ? 'active' : ''}" data-fac-id="${fac.id}">${fac.name}</button>`;
            });
            document.getElementById('facility-selector').innerHTML = selectorHtml;

            // äº‹æ¥­æ‰€é¸æŠã‚¤ãƒ™ãƒ³ãƒˆ
            document.querySelectorAll('.selector-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    currentFacility = parseInt(this.getAttribute('data-fac-id'));
                    renderInputForm();
                });
            });

            let authHtml = `
                <div style="max-width: 400px; margin: 40px auto; padding: 30px; background: #FBF9FA; border-radius: 12px; border: 2px solid #D99AAD; text-align: center;">
                    <div style="font-size: 18px; font-weight: bold; color: #D99AAD; margin-bottom: 20px;">ğŸ”’ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼</div>
                    <div style="font-size: 14px; color: #2D2E1B; margin-bottom: 20px;">${f.name}</div>
                    <div class="form-group">
                        <label style="text-align: left;">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</label>
                        <input type="password" id="auth-password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
                    </div>
                    <button class="save-btn" id="login-btn">ãƒ­ã‚°ã‚¤ãƒ³</button>
                </div>
            `;
            document.getElementById('input-form').innerHTML = authHtml;
            
            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
            setTimeout(() => {
                const passwordInput = document.getElementById('auth-password');
                const loginBtn = document.getElementById('login-btn');
                
                if (passwordInput && loginBtn) {
                    loginBtn.addEventListener('click', () => authenticatePassword(f));
                    
                    passwordInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') authenticatePassword(f);
                    });
                    
                    passwordInput.focus();
                }
            }, 100);
        }

        function authenticatePassword(f) {
            console.log('èªè¨¼é–‹å§‹:', f.name);
            const inputElement = document.getElementById('auth-password');
            console.log('å…¥åŠ›æ¬„:', inputElement);
            
            if (!inputElement) {
                console.error('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›æ¬„ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                alert('ã‚¨ãƒ©ãƒ¼: å…¥åŠ›æ¬„ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }
            
            const inputPassword = inputElement.value.trim();
            console.log('å…¥åŠ›ã•ã‚ŒãŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰:', inputPassword);
            console.log('æ­£ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰:', f.password);
            console.log('ä¸€è‡´:', inputPassword === f.password);
            
            if (inputPassword === f.password) {
                console.log('èªè¨¼æˆåŠŸï¼');
                authenticatedFacilities[f.id] = true;
                console.log('authenticatedFacilities:', authenticatedFacilities);
                renderInputForm();
            } else {
                console.log('èªè¨¼å¤±æ•—');
                alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé–“é•ã£ã¦ã„ã¾ã™');
                inputElement.value = '';
                inputElement.focus();
            }
        }

        function renderEditForm(f) {
            console.log('renderEditForm é–‹å§‹:', f.name);
            console.log('data[currentFacility]:', data[currentFacility]);
            
            let selectorHtml = '';
            facilities.forEach(fac => {
                selectorHtml += `<button class="selector-btn ${fac.id === currentFacility ? 'active' : ''}" data-fac-id="${fac.id}">${fac.name}</button>`;
            });
            document.getElementById('facility-selector').innerHTML = selectorHtml;

            // äº‹æ¥­æ‰€é¸æŠã‚¤ãƒ™ãƒ³ãƒˆ
            document.querySelectorAll('.selector-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    currentFacility = parseInt(this.getAttribute('data-fac-id'));
                    renderInputForm();
                });
            });

            let formHtml = '';
            
            if (f.type === 'day' || f.type === 'visit' || f.type === 'complex') {
                formHtml += '<div style="margin-bottom: 20px;"><strong style="font-size: 14px;">æ›œæ—¥ã”ã¨ã®å‹Ÿé›†çŠ¶æ³ã‚’å…¥åŠ›</strong></div>';
                formHtml += `
                    <div style="background: #FBF9FA; border: 1px solid #D99AAD; border-radius: 6px; padding: 12px; margin-bottom: 20px;">
                        <strong style="font-size: 12px; color: #D99AAD;">å®šä¼‘æ—¥ã‚’è¨­å®š</strong>
                        <div class="checkbox-group" style="margin-top: 8px;">`;
                
                days.forEach(d => {
                    formHtml += `
                        <div class="checkbox-item">
                            <input type="checkbox" class="holiday-check" data-day="${d}" ${data[currentFacility].holidays && data[currentFacility].holidays.includes(d) ? 'checked' : ''}>
                            <label>${dayLabels[d]}æ›œæ—¥</label>
                        </div>`;
                });
                
                formHtml += `</div></div>`;

                days.forEach(d => {
                    if (data[currentFacility].holidays && data[currentFacility].holidays.includes(d)) return;
                    const d_data = data[currentFacility][d];
                    
                    formHtml += `
                        <div class="day-section">
                            <div class="day-title">${dayLabels[d]}æ›œæ—¥</div>
                            <div class="checkbox-group">
                                <div class="checkbox-item">
                                    <input type="checkbox" class="time-check" data-day="${d}" data-time="morning" ${d_data.morning ? 'checked' : ''}>
                                    <label>åˆå‰</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" class="time-check" data-day="${d}" data-time="afternoon" ${d_data.afternoon ? 'checked' : ''}>
                                    <label>åˆå¾Œ</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" class="time-check" data-day="${d}" data-time="evening" ${d_data.evening ? 'checked' : ''}>
                                    <label>å¤œé–“</label>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>å¯¾å¿œè¦ä»‹è­·åº¦ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</label>
                                <div class="checkbox-group">`;
                    
                    ['è¦æ”¯æ´1', 'è¦æ”¯æ´2', 'è¦ä»‹è­·1', 'è¦ä»‹è­·2', 'è¦ä»‹è­·3', 'è¦ä»‹è­·4', 'è¦ä»‹è­·5', 'éè©²å½“'].forEach(level => {
                        formHtml += `
                            <div class="checkbox-item">
                                <input type="checkbox" class="care-check" data-day="${d}" data-level="${level}" ${d_data.care[level] ? 'checked' : ''}>
                                <label>${level}</label>
                            </div>`;
                    });
                    
                    formHtml += `</div></div>`;

                    if (f.type === 'visit' || f.type === 'complex') {
                        formHtml += `
                            <div class="form-group">
                                <label>å¯¾å¿œéšœå®³ç­‰ç´šï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</label>
                                <div class="checkbox-group">`;
                        
                        ['1', '2', '3', '4', '5', '6', '7'].forEach(level => {
                            formHtml += `
                                <div class="checkbox-item">
                                    <input type="checkbox" class="disability-check" data-day="${d}" data-level="${level}" ${d_data.disability[level] ? 'checked' : ''}>
                                    <label>ç¬¬${level}ç´š</label>
                                </div>`;
                        });
                        
                        formHtml += `</div></div>`;
                    }

                    formHtml += `
                            <div class="form-group">
                                <label>ãã®ä»–å‚™è€ƒ</label>
                                <textarea class="note-input" data-day="${d}">${d_data.note || ''}</textarea>
                            </div>
                        </div>`;
                });
            } else {
                formHtml += '<div style="margin-bottom: 20px;"><strong style="font-size: 14px;">åŸºæœ¬æƒ…å ±</strong></div>';
                formHtml += `
                    <div class="form-group">
                        <label>é›»è©±ç•ªå·</label>
                        <input type="tel" id="facility-phone" value="${data[currentFacility].phone || ''}">
                    </div>
                    <div class="form-group">
                        <label>å‹Ÿé›†çŠ¶æ³</label>
                        <select id="facility-status">
                            <option value="open" ${data[currentFacility].status === 'open' ? 'selected' : ''}>å‹Ÿé›†ä¸­</option>
                            <option value="limited" ${data[currentFacility].status === 'limited' ? 'selected' : ''}>é™å®šå‹Ÿé›†</option>
                            <option value="closed" ${data[currentFacility].status === 'closed' ? 'selected' : ''}>å‹Ÿé›†ãªã—</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>å®šå“¡æ®‹æ•°ï¼ˆåï¼‰</label>
                        <input type="number" id="facility-capacity" value="${data[currentFacility].capacity}" min="0">
                    </div>`;

                if (f.category === 'æ–½è¨­ç³»') {
                    formHtml += `
                        <div class="form-group">
                            <label>å¯¾å¿œè¦ä»‹è­·åº¦ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</label>
                            <div class="checkbox-group">`;
                    
                    ['è¦æ”¯æ´1', 'è¦æ”¯æ´2', 'è¦ä»‹è­·1', 'è¦ä»‹è­·2', 'è¦ä»‹è­·3', 'è¦ä»‹è­·4', 'è¦ä»‹è­·5', 'éè©²å½“'].forEach(level => {
                        formHtml += `
                            <div class="checkbox-item">
                                <input type="checkbox" class="facility-care-check" data-level="${level}" ${data[currentFacility].care[level] ? 'checked' : ''}>
                                <label>${level}</label>
                            </div>`;
                    });
                    
                    formHtml += `</div></div>`;
                }

                if (f.category === 'éšœå®³ç³»') {
                    formHtml += `
                        <div class="form-group">
                            <label>å¯¾å¿œéšœå®³ç­‰ç´šï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</label>
                            <div class="checkbox-group">`;
                    
                    ['1', '2', '3', '4', '5', '6', '7'].forEach(level => {
                        formHtml += `
                            <div class="checkbox-item">
                                <input type="checkbox" class="facility-disability-check" data-level="${level}" ${data[currentFacility].disability[level] ? 'checked' : ''}>
                                <label>ç¬¬${level}ç´š</label>
                            </div>`;
                    });
                    
                    formHtml += `</div></div>`;
                }

                formHtml += `
                    <div class="form-group">
                        <label>å‚™è€ƒ</label>
                        <textarea id="facility-note">${data[currentFacility].note || ''}</textarea>
                    </div>`;
            }

            formHtml += '<button class="save-btn" id="save-logout-btn">ä¿å­˜ã—ã¦ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>';
            document.getElementById('input-form').innerHTML = formHtml;

            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
            attachFormEventListeners(f);
        }

        function attachFormEventListeners(f) {
            // å®šä¼‘æ—¥ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹
            document.querySelectorAll('.holiday-check').forEach(checkbox => {
                checkbox.addEventListener('change', async function() {
                    const day = this.getAttribute('data-day');
                    if (!data[currentFacility].holidays) data[currentFacility].holidays = [];
                    
                    if (this.checked) {
                        if (!data[currentFacility].holidays.includes(day)) {
                            data[currentFacility].holidays.push(day);
                        }
                    } else {
                        data[currentFacility].holidays = data[currentFacility].holidays.filter(d => d !== day);
                    }
                    await saveData();
                    renderInputForm();
                });
            });

            // æ™‚é–“å¸¯ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹
            document.querySelectorAll('.time-check').forEach(checkbox => {
                checkbox.addEventListener('change', async function() {
                    const day = this.getAttribute('data-day');
                    const time = this.getAttribute('data-time');
                    data[currentFacility][day][time] = this.checked;
                    data[currentFacility][day].lastUpdated = new Date().toISOString();
                    await saveData();
                });
            });

            // è¦ä»‹è­·åº¦ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ï¼ˆæ›œæ—¥åˆ¥ï¼‰
            document.querySelectorAll('.care-check').forEach(checkbox => {
                checkbox.addEventListener('change', async function() {
                    const day = this.getAttribute('data-day');
                    const level = this.getAttribute('data-level');
                    data[currentFacility][day].care[level] = this.checked;
                    data[currentFacility][day].lastUpdated = new Date().toISOString();
                    await saveData();
                });
            });

            // éšœå®³ç­‰ç´šãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ï¼ˆæ›œæ—¥åˆ¥ï¼‰
            document.querySelectorAll('.disability-check').forEach(checkbox => {
                checkbox.addEventListener('change', async function() {
                    const day = this.getAttribute('data-day');
                    const level = this.getAttribute('data-level');
                    data[currentFacility][day].disability[level] = this.checked;
                    data[currentFacility][day].lastUpdated = new Date().toISOString();
                    await saveData();
                });
            });

            // å‚™è€ƒå…¥åŠ›ï¼ˆæ›œæ—¥åˆ¥ï¼‰
            document.querySelectorAll('.note-input').forEach(textarea => {
                textarea.addEventListener('change', async function() {
                    const day = this.getAttribute('data-day');
                    data[currentFacility][day].note = this.value;
                    data[currentFacility][day].lastUpdated = new Date().toISOString();
                    await saveData();
                });
            });

            // æ–½è¨­ç³»ã®å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
            const phoneInput = document.getElementById('facility-phone');
            if (phoneInput) {
                phoneInput.addEventListener('change', async function() {
                    data[currentFacility].phone = this.value;
                    data[currentFacility].lastUpdated = new Date().toISOString();
                    await saveData();
                });
            }

            const statusSelect = document.getElementById('facility-status');
            if (statusSelect) {
                statusSelect.addEventListener('change', async function() {
                    data[currentFacility].status = this.value;
                    data[currentFacility].lastUpdated = new Date().toISOString();
                    await saveData();
                });
            }

            const capacityInput = document.getElementById('facility-capacity');
            if (capacityInput) {
                capacityInput.addEventListener('change', async function() {
                    data[currentFacility].capacity = parseInt(this.value) || 0;
                    data[currentFacility].lastUpdated = new Date().toISOString();
                    await saveData();
                });
            }

            // è¦ä»‹è­·åº¦ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ï¼ˆæ–½è¨­ï¼‰
            document.querySelectorAll('.facility-care-check').forEach(checkbox => {
                checkbox.addEventListener('change', async function() {
                    const level = this.getAttribute('data-level');
                    data[currentFacility].care[level] = this.checked;
                    data[currentFacility].lastUpdated = new Date().toISOString();
                    await saveData();
                });
            });

            // éšœå®³ç­‰ç´šãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ï¼ˆæ–½è¨­ï¼‰
            document.querySelectorAll('.facility-disability-check').forEach(checkbox => {
                checkbox.addEventListener('change', async function() {
                    const level = this.getAttribute('data-level');
                    data[currentFacility].disability[level] = this.checked;
                    data[currentFacility].lastUpdated = new Date().toISOString();
                    await saveData();
                });
            });

            const noteTextarea = document.getElementById('facility-note');
            if (noteTextarea) {
                noteTextarea.addEventListener('change', async function() {
                    data[currentFacility].note = this.value;
                    data[currentFacility].lastUpdated = new Date().toISOString();
                    await saveData();
                });
            }

            // ä¿å­˜ã—ã¦ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒœã‚¿ãƒ³
            const saveLogoutBtn = document.getElementById('save-logout-btn');
            if (saveLogoutBtn) {
                saveLogoutBtn.addEventListener('click', async function() {
                    await saveData();
                    authenticatedFacilities[currentFacility] = false;
                    alert('ä¿å­˜ã—ã¾ã—ãŸã€‚ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã€‚');
                    switchTab('view');
                });
            }
        }

        // åˆæœŸåŒ–
        loadData();
        setupRealtimeListener();
    </script>
</body>
</html>
